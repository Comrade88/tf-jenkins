pipeline {
    agent {
        label 'aws'
    }
    environment {
        SLAVE = "aws"
        PATCHSET_ID = "12345/1"
        CONTAINER_REGISTRY = "pnexus.sytes.net:5001"
    }
    stages {
        stage('Prepare environment file') {
            steps {
                sh 'echo "PATCHSET_ID=$PATCHSET_ID" > stackrc-$BUILD_ID.env'
                sh 'echo "CONTAINER_REGISTRY=$CONTAINER_REGISTRY" >> stackrc-$BUILD_ID.env'
            }
        }
        stage('Fetch') {
            steps{
                load stackrc-$BUILD_ID.env
                script {
                    build 'fetch-sources'
                }
            }
        }
        stage('Check'){
            parallel {
                stage('Unit-test'){
                    steps{
                        catchError(buildResult: 'FAILURE', stageResult: 'FAILURE'){
                            build job: 'test-unit',
                                parameters: [
                                    [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                ]
                            }
                        }
                    }
                stage('Lint'){
                    steps{
                        catchError(buildResult: 'FAILURE', stageResult: 'FAILURE'){
                            build job: 'test-lint',
                                parameters: [
                                    [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                ]
                        }
                    }
                }
                stage('Deploy k8s for manifests'){
                    steps{
                        catchError(buildResult: 'FAILURE', stageResult: 'FAILURE'){
                            script{
                                build job: 'deploy-platform-k8s_manifests',
                                    parameters: [
                                        [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                    ]
                            }
                        }
                    }
                }
                stage('Deploy k8s for helm'){
                    steps{
                        catchError(buildResult: 'FAILURE', stageResult: 'FAILURE'){
                            script{
                                build job: 'deploy-platform-k8s_helm',
                                    parameters: [
                                        [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                    ]
                            }
                        }
                    }
                }
                stage('Deploy k8s for juju'){
                    steps{
                        catchError(buildResult: 'FAILURE', stageResult: 'FAILURE'){
                            script{
                                build job: 'deploy-platform-k8s_juju',
                                    parameters: [
                                        [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                    ]
                            }
                        }
                    }
                }
                stage('Deploy openstack for helm'){
                    steps{
                        catchError(buildResult: 'FAILURE', stageResult: 'FAILURE'){
                            script{
                                build job: 'deploy-platform-os_helm',
                                    parameters: [
                                        [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                    ]
                            }
                        }
                    }
                }
                stage('Build-test'){
                    stages{
                        stage('Build'){
                            load stackrc-$BUILD_ID.env
                            steps{
                                catchError(buildResult: 'FAILURE', stageResult: 'FAILURE'){
                                    build job: 'build',
                                        parameters: [
                                            [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                        ]
                                }
                            }
                        }
                        stage('Deploy TF') {
                            steps{
                                script {
                                    int ERRORS = 0
                                    parallel(
                                        "Deploy-test k8s for manifests": {
                                            try {
                                                build job: 'deploy-tf-k8s_manifests',
                                                    parameters: [
                                                        [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                                    ]
                                            } catch (err) {
                                                ++ERRORS
                                            }
                                            parallel(
                                                "Test sanity k8s for manifests": {
                                                    build job: 'test-sanity',
                                                        parameters: [
                                                            [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                                        ]
                                                },
                                                "Test smoke k8s for manifests": {
                                                    build job: 'test-smoke',
                                                        parameters: [
                                                            [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                                        ]
                                                }
                                            )
                                        },
                                        "Deploy-test k8s for helm": {
                                            try {
                                                build job: 'deploy-tf-k8s_helm',
                                                    parameters: [
                                                        [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                                    ]
                                            } catch (err) {
                                                ++ERRORS
                                            }
                                            parallel(
                                                "Test sanity k8s for manifests": {
                                                    build job: 'test-sanity',
                                                        parameters: [
                                                            [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                                        ]
                                                },
                                                "Test smoke k8s for manifests": {
                                                    build job: 'test-smoke',
                                                        parameters: [
                                                            [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                                        ]
                                                }
                                            )
                                        },
                                        "Deploy-test k8s for juju": {
                                            try {
                                                build job: 'deploy-tf-k8s_juju',
                                                    parameters: [
                                                        [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                                    ]
                                            } catch (err) {
                                                ++ERRORS
                                            }
                                            parallel(
                                                "Test sanity k8s for juju": {
                                                    build job: 'test-sanity',
                                                        parameters: [
                                                            [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                                        ]
                                                },
                                                "Test smoke k8s for manifests": {
                                                    build job: 'test-smoke',
                                                        parameters: [
                                                            [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                                        ]
                                                }
                                            )
                                        },
                                        "Deploy-test openstack for helm": {
                                            try {
                                                build job: 'deploy-tf-os_helm',
                                                    parameters: [
                                                        [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                                    ]
                                            } catch (err) {
                                                ++ERRORS
                                            }
                                            parallel(
                                                "Test sanity openstack for helm": {
                                                    build job: 'test-sanity',
                                                        parameters: [
                                                            [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                                        ]
                                                },
                                                "Test smoke openstack for helm": {
                                                    build job: 'test-smoke',
                                                        parameters: [
                                                            [$class: 'LabelParameterValue', name: 'SLAVE', label: "${SLAVE}" ]
                                                        ]
                                                }
                                            )
                                        }
                                    )
                                    if ( ERRORS > 0 ) {
                                        currentBuild.result = 'FAILED'
                                        sh "exit 1"
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
    post {
        always {
            sh "echo 'Destroy VMs'"
        }
        failure {
            sh "echo 'archiveArtifacts'"
            sh "echo 'gerrit vote'"
        }
        success {
            sh "echo 'gerrit vote'"
            sh "echo publishArtifact"
        }
        cleanup {
            sh "echo 'remove trash'"
            //deleteDir()
        }
    }
}
