---

- job:
    name: check-abandon
    node: master
    description: check-abandon
    project-type: pipeline
    concurrent: true
    triggers:
      - gerrit:
          server-name: review.opencontrail.org
          skip-vote:
            successful: true
            failed: true
            unstable: true
            notbuilt: true
          trigger-on:
            - change-abandoned-event 
          projects:
            - project-compare-type: 'ANT'
              project-pattern: '**'
              branches:
                - branch-compare-type: 'REG_EXP'
                  branch-pattern: '^master'
    dsl: |
        instance = Jenkins.getInstanceOrNull()
        runningBuilds = instance.getView('All').getBuilds().findAll() { it.getResult().equals(null) }
        runningBuilds.removeAll { it.grep( ~/check-abandon.*/ ) }
        for (rb in runningBuilds) {
          if ( rb.allActions.find {it in hudson.model.ParametersAction}.getParameter("GERRIT_CHANGE_NUMBER") != null ) {
            change_num = rb.allActions.find {it in hudson.model.ParametersAction}.getParameter("GERRIT_CHANGE_NUMBER").value.toInteger()
            if (GERRIT_CHANGE_NUMBER.toInteger() == change_num ){
              rb.doStop()
              println "Build $rb has been aborted when the change $GERRIT_CHANGE_NUMBER abandoned."
            }
          }
        }
