---
- job-template:
    name: devstack-{project}-{slave}
    description: "Deploys {project}"
    node: '{slave}'
    defaults: global
    properties:
      - build-discarder:
          num-to-keep: 10
    concurrent: true
    wrappers:
      - ssh-agent-credentials:
          users:
            - 'worker'
      - credentials-binding:
          - amazon-web-services:
              credential-id: aws-creds
              access-key: AWS_ACCESS_KEY_ID
              secret-key: AWS_SECRET_ACCESS_KEY
    scm:
      - tf-jenkins
      - tf-devstack
    builders:
      - shell: |
          ./tf-jenkins/infra/{slave}/create_vms.sh
      - shell: |
          # Deploy devstack
          ENV_FILE="$WORKSPACE/stackrc"
          SSH_OPTIONS="-o User=ec2-user -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -o ConnectionAttempts=100"
          tar cvzf tf-devstack.tgz tf-devstack/
          scp $SSH_OPTIONS ./tf-devstack.tgz $instance_ip:./
          ssh $SSH_OPTIONS -t $instance_ip \
              "tar -xzf tf-devstack.tgz && sudo yum install git -y"
          ssh $SSH_OPTIONS -t $instance_ip \
              "export PATH=$PATH:/usr/local/sbin:/usr/sbin:/sbin && cd tf-devstack/{project} && ./startup.sh"
    publishers:
      - postbuildscript:
          builders:
            - role: BOTH
              build-on:
                - SUCCESS
                - UNSTABLE
                - FAILURE
                - NOT_BUILT
                - ABORTED
              build-steps:
                - shell: |
                    ./tf-jenkins/infra/{slave}/remove_vms.sh

- project:
    name: devstack
    project:
      - k8s_manifests
      - ansible
    slave:
      - aws
      - vexxhost
    jobs:
      - 'devstack-{project}-{slave}'
