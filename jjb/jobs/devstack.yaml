---
- job-template:
    name: devstack-{project}-{slave}
    description: "Deploys {project}"
    node: '{slave}'
    defaults: global
    properties:
      - build-discarder:
          num-to-keep: 10
    concurrent: true
    wrappers:
      - ssh-agent-credentials:
          users:
            - 'worker'
      - credentials-binding:
          - amazon-web-services:
              credential-id: aws-creds
              access-key: AWS_ACCESS_KEY_ID
              secret-key: AWS_SECRET_ACCESS_KEY
    scm:
      - tf-jenkins
      - tf-devstack
    builders:
      - shell: |
          ./src/progmaticlab/tf-jenkins/infra/{slave}/create_vms.sh
      - shell: |
          ./src/progmaticlab/tf-jenkins/jobs/devstack/run.sh
    publishers:
      - postbuildscript:
          builders:
            - role: BOTH
              build-on:
                - SUCCESS
                - UNSTABLE
                - FAILURE
                - NOT_BUILT
                - ABORTED
              build-steps:
                - shell: |
                    ./src/progmaticlab/tf-jenkins/infra/{slave}/remove_vms.sh

- project:
    name: devstack
    project:
      - k8s_manifests
      - ansible
    slave:
      - aws
      - vexxhost
    jobs:
      - 'devstack-{project}-{slave}'
