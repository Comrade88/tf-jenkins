- name: Install required packages
  apt:
    name: "{{ required_pkgs }}"
    state: present
    update_cache: yes

- name: Install pip packages for aws
  pip:
    name: awscli
    executable: pip3
  when: "'aws' in group_names"

- name: Install pip packages for vexx
  pip:
    name:
      - python-openstackclient
      - python-novaclient
    executable: pip3
  when: "'vexxhost' in group_names"

- name: Add user jenkins
  user:
    name: "{{ jenkins_user }}"

- name: Make ~/.ssh directory
  file:
    path: /home/{{ jenkins_user }}/.ssh
    owner: "{{ jenkins_user }}"
    group: "{{ jenkins_user }}"
    mode: "0700"
    state: directory

- name: Creating a keypair for connecting slaves
  openssh_keypair:
    path: "{{ playbook_dir }}/jenkins_id_ssh_rsa"
  register: keypair
  when: jenkins_new_deploy
  delegate_to: localhost
  become: no

- name: Append string to list
  set_fact:
    jenkins_ssh_pubkeys: "{{ [keypair.public_key] + jenkins_ssh_pubkeys }}"
  when: jenkins_new_deploy

- name: Add trusted ssh pubkeys to jenkins authorized_keys file
  blockinfile:
    dest: /home/{{ jenkins_user }}/.ssh/authorized_keys
    create: yes
    marker: "# {mark} Ansible managed default keys"
    block: |
      {% for key in jenkins_ssh_pubkeys %}
      {{ key }}
      {% endfor %}
    owner: "{{ jenkins_user }}"
    group: "{{ jenkins_user }}"
    mode: "0600"
